---
phase: 03-data-population
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [src/services/processing/anomaly_tracker.py, src/services/processing/data_processor.py]
autonomous: true
---

<objective>
Update anomaly event logging to include kafa_yuksekligi (head height) value.

Purpose: Record head height at time of anomaly detection for historical analysis - knowing where the saw head was when an anomaly occurred provides context for diagnosing cutting issues.
Output: Anomaly events now include kafa_yuksekligi value when logged to database.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-anomaly-schema-update/02-01-SUMMARY.md

@src/services/processing/anomaly_tracker.py
@src/services/processing/data_processor.py
@src/domain/models.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add kafa_yuksekligi parameter to record_anomaly method</name>
  <files>src/services/processing/anomaly_tracker.py</files>
  <action>
Modify the `record_anomaly` method (around line 74) to:

1. Add `kafa_yuksekligi: Optional[float] = None` parameter
2. Pass this value to `_save_anomaly_to_db`

Modify `_save_anomaly_to_db` method (around line 117) to:

1. Add `kafa_yuksekligi: Optional[float]` parameter
2. Update the SQL INSERT statement to include kafa_yuksekligi column
3. Add kafa_yuksekligi to the params tuple

Current INSERT columns: timestamp, sensor_name, sensor_value, detection_method, kesim_id
Updated INSERT columns: timestamp, sensor_name, sensor_value, detection_method, kesim_id, kafa_yuksekligi
  </action>
  <verify>grep -A 15 "def record_anomaly" src/services/processing/anomaly_tracker.py | grep kafa_yuksekligi</verify>
  <done>record_anomaly and _save_anomaly_to_db accept and store kafa_yuksekligi parameter</done>
</task>

<task type="auto">
  <name>Task 2: Update data_processor to pass kafa_yuksekligi when recording anomalies</name>
  <files>src/services/processing/data_processor.py</files>
  <action>
Modify the anomaly recording call in `_process_sensors` method (around line 286) to pass the head height value:

Change from:
```python
self.anomaly_tracker.record_anomaly(
    sensor_name=sensor_name,
    sensor_value=sensor_value,
    detection_method=self.anomaly_manager.get_method_for_sensor(sensor_name),
    kesim_id=kesim_id
)
```

To:
```python
self.anomaly_tracker.record_anomaly(
    sensor_name=sensor_name,
    sensor_value=sensor_value,
    detection_method=self.anomaly_manager.get_method_for_sensor(sensor_name),
    kesim_id=kesim_id,
    kafa_yuksekligi=raw_data.kafa_yuksekligi_mm
)
```

The `raw_data` variable is already in scope at this location (it's the RawSensorData being processed).
  </action>
  <verify>grep -A 6 "record_anomaly" src/services/processing/data_processor.py | grep kafa_yuksekligi</verify>
  <done>data_processor passes kafa_yuksekligi when recording anomalies</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `kafa_yuksekligi` parameter added to record_anomaly method
- [ ] `kafa_yuksekligi` column included in INSERT statement
- [ ] data_processor passes kafa_yuksekligi value
- [ ] Python syntax valid: `python -c "import src.services.processing.anomaly_tracker; import src.services.processing.data_processor"`
</verification>

<success_criteria>

- Anomaly event logging includes kafa_yuksekligi value
- No syntax errors in modified files
- Code follows existing style patterns
  </success_criteria>

<output>
After completion, create `.planning/phases/03-data-population/03-02-SUMMARY.md`
</output>
