---
phase: 03-data-population
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/services/control/ml_controller.py]
autonomous: true
---

<objective>
Update ML prediction logging to include serit_motor_tork and kafa_yuksekligi values.

Purpose: Populate the new ML schema columns with actual sensor data for historical torque and head height analysis.
Output: ML predictions now include torque and head height values when logged to database.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-ml-schema-update/01-01-SUMMARY.md

@src/services/control/ml_controller.py
@src/domain/models.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update _log_ml_prediction to include torque and head height</name>
  <files>src/services/control/ml_controller.py</files>
  <action>
Modify the `_log_ml_prediction` method (around line 620) to:

1. Accept additional parameters for `serit_motor_tork` and `kafa_yuksekligi`
2. Update the SQL INSERT statement to include the new columns
3. Add the new values to the params tuple

The method currently inserts: timestamp, akim_input, sapma_input, kesme_hizi_input, inme_hizi_input, ml_output

Update to also insert: serit_motor_tork, kafa_yuksekligi

For the torque value, use the averaged torque from preprocessor (already available in `_predict_coefficient`).
For the head height, pass it from `calculate_speeds` where `processed_data.raw_data.kafa_yuksekligi_mm` is available.

Note: The method is called from `_predict_coefficient` which doesn't have direct access to raw_data. Either:
- Pass raw_data to `_predict_coefficient` (cleanest)
- Or store necessary values as instance variables before calling

Recommended approach: Modify `_predict_coefficient` to accept `raw_data` parameter and extract values there.
  </action>
  <verify>grep -A 20 "def _log_ml_prediction" src/services/control/ml_controller.py | grep -E "serit_motor_tork|kafa_yuksekligi"</verify>
  <done>_log_ml_prediction inserts serit_motor_tork and kafa_yuksekligi values into ml_predictions table</done>
</task>

<task type="auto">
  <name>Task 2: Update _predict_coefficient to pass raw_data for logging</name>
  <files>src/services/control/ml_controller.py</files>
  <action>
Modify `_predict_coefficient` method (around line 247) to:

1. Accept `raw_data` as a parameter
2. Extract `serit_motor_tork_percentage` and `kafa_yuksekligi_mm` from raw_data
3. Pass these values to `_log_ml_prediction`

Update the call site in `calculate_speeds` (around line 195) to pass `processed_data.raw_data` to `_predict_coefficient`.

For torque, use `raw_data.serit_motor_tork_percentage` directly (not the buffer average, since we want the instantaneous value at prediction time).
  </action>
  <verify>grep -B 2 "_predict_coefficient" src/services/control/ml_controller.py | grep "raw_data"</verify>
  <done>_predict_coefficient accepts raw_data and passes torque/height values to logging method</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `serit_motor_tork` column included in INSERT statement
- [ ] `kafa_yuksekligi` column included in INSERT statement
- [ ] Python syntax valid: `python -c "import src.services.control.ml_controller"`
</verification>

<success_criteria>

- ML prediction logging includes serit_motor_tork value
- ML prediction logging includes kafa_yuksekligi value
- No syntax errors in ml_controller.py
- Code follows existing style (same parameter passing patterns)
  </success_criteria>

<output>
After completion, create `.planning/phases/03-data-population/03-01-SUMMARY.md`
</output>
