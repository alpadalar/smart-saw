---
phase: 10-ai-mode-switch-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/core/lifecycle.py
  - src/gui/app.py
  - src/gui/controllers/main_controller.py
  - src/gui/controllers/control_panel_controller.py
autonomous: true
---

<objective>
Fix cross-thread asyncio scheduling in GUI mode switch operations.

Purpose: GUI thread (Qt) cannot safely schedule coroutines on main thread's asyncio loop using `asyncio.ensure_future()`. This causes mode switch failures when clicking AI/Manual mode buttons.

Output: Mode switching works correctly from GUI thread via `asyncio.run_coroutine_threadsafe()`.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# The bug:
# GUI runs in separate thread (lifecycle.py:382-387 starts gui_thread)
# ControlPanelController._switch_controller() uses asyncio.ensure_future() from GUI thread
# asyncio.ensure_future() is not thread-safe for cross-thread scheduling
#
# Solution: asyncio.run_coroutine_threadsafe(coro, loop) is the proper pattern

@src/core/lifecycle.py
@src/gui/app.py
@src/gui/controllers/main_controller.py
@src/gui/controllers/control_panel_controller.py
@src/services/control/manager.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Pass event loop through GUI initialization chain</name>
  <files>src/core/lifecycle.py, src/gui/app.py, src/gui/controllers/main_controller.py</files>
  <action>
1. In lifecycle.py `_init_gui()`: Capture event loop and pass to GUIApplication
   - Get loop with `asyncio.get_running_loop()` (inside async method)
   - Pass as `event_loop` parameter to GUIApplication constructor

2. In app.py `GUIApplication.__init__()`: Store event loop reference
   - Add `event_loop` parameter after `data_pipeline`
   - Store as `self.event_loop`
   - Pass to MainController in `_run_gui()`

3. In main_controller.py `MainController.__init__()`: Store and propagate loop
   - Add `event_loop=None` parameter after `data_pipeline`
   - Store as `self.event_loop`
   - Pass to ControlPanelController in `_setup_pages()`

Note: Use `event_loop=None` default in app.py and main_controller.py for backward compatibility if GUI is started standalone.
  </action>
  <verify>python -c "from src.gui.app import GUIApplication; from src.gui.controllers.main_controller import MainController; print('Imports OK')"</verify>
  <done>Event loop reference flows: lifecycle → GUIApplication → MainController → ControlPanelController</done>
</task>

<task type="auto">
  <name>Task 2: Replace ensure_future with run_coroutine_threadsafe in ControlPanelController</name>
  <files>src/gui/controllers/control_panel_controller.py</files>
  <action>
1. Add `event_loop=None` parameter to `__init__()` after `parent`
   - Store as `self.event_loop`

2. In `_switch_controller()` (around line 1425-1437):
   - Replace the entire try block with:
     ```python
     if self.control_manager and hasattr(self.control_manager, 'set_mode'):
         if self.event_loop:
             # Thread-safe scheduling from GUI thread to asyncio loop
             asyncio.run_coroutine_threadsafe(
                 self.control_manager.set_mode(mode),
                 self.event_loop
             )
         else:
             # Fallback if no event loop (standalone testing)
             logger.warning("No event loop - mode switch may not work")
         logger.info(f"Control mode switched to: {mode.value}")
     ```

3. In `_send_current_speeds()` (around line 1494-1519):
   - Apply same pattern for `manual_set_speeds()` call:
     ```python
     if self.event_loop:
         asyncio.run_coroutine_threadsafe(
             self.control_manager.manual_set_speeds(cutting_speed, descent_speed),
             self.event_loop
         )
     else:
         logger.warning("No event loop - speed command may not work")
     ```
   - Remove the `asyncio.run()` fallback (it was incorrect anyway - can't run new loop from Qt thread)

Avoid: Don't use `asyncio.run()` from GUI thread - it tries to create a new event loop which conflicts with Qt's event loop.
  </action>
  <verify>grep -n "run_coroutine_threadsafe" src/gui/controllers/control_panel_controller.py | head -5</verify>
  <done>GUI thread uses asyncio.run_coroutine_threadsafe() for all async calls to control_manager</done>
</task>

<task type="auto">
  <name>Task 3: Verify application startup and mode switching</name>
  <files></files>
  <action>
1. Start the application:
   ```bash
   timeout 10 python run.py 2>&1 || true
   ```
   - Verify no import errors
   - Verify GUI initializes
   - Verify control manager initializes
   - Check for any errors related to event loop or threading

2. Verify the fix is syntactically correct:
   ```bash
   python -m py_compile src/gui/controllers/control_panel_controller.py
   python -m py_compile src/gui/app.py
   python -m py_compile src/gui/controllers/main_controller.py
   python -m py_compile src/core/lifecycle.py
   ```

Note: Full functional testing of mode switch requires running GUI with Modbus connection, which is out of scope for automated verification.
  </action>
  <verify>python -m py_compile src/gui/controllers/control_panel_controller.py && echo "Syntax OK"</verify>
  <done>Application starts without errors, all modified files compile successfully</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Event loop flows through: lifecycle → GUIApplication → MainController → ControlPanelController
- [ ] `asyncio.run_coroutine_threadsafe()` used in `_switch_controller()`
- [ ] `asyncio.run_coroutine_threadsafe()` used in `_send_current_speeds()`
- [ ] All modified files pass `python -m py_compile`
- [ ] Application starts without import errors
</verification>

<success_criteria>
- All tasks completed
- Event loop reference passed through GUI initialization chain
- Cross-thread asyncio calls use run_coroutine_threadsafe
- No syntax errors in modified files
- Application startup succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/10-ai-mode-switch-fix/10-01-SUMMARY.md`
</output>
